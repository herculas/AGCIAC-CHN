\chapter{消息完整性}\label{chap:6}

在前几章中，我们重点讨论了针对窃听对手的安全性。窃听攻击的对手有能力窃听传输的消息，但不能在途中篡改这些消息。我们表明，选择明文安全是抵御这种攻击所需的自然安全属性。

在本章中，我们将注意力转向主动对手。我们从\emph{消息完整性}的基本问题开始。Bob 从 Alice 那里收到一条消息 $m$，并想确认这条消息在传输过程中没有遭到篡改。我们将会设计一个机制，它能让 Alice 为消息 $m$ 计算一个简短的消息完整性标签 $t$，并将这个数对 $(m,t)$ 发送给 Bob，如图 \ref{fig:6-1} 所示。Bob 在收到数对后会检查标签 $t$，如果检查未能通过，他就拒绝该消息。反之，如果验证通过，Bob 就能确信消息在传输途中并未遭到篡改。

需要强调的是，本章中的消息本身不需要是秘密的。和前几章不同，在本章中，我们的目标并不是隐藏信息。相反，我们只关注消息的完整性。在第\ref{chap:9}章中，我们还会讨论同时保证消息的机密性和完整性这一更普遍的问题。有许多应用需要保证消息的完整性，但并不要求机密性。我们举两个例子。

\begin{example}\label{exmp:6-1}
考虑一下通过互联网传递金融新闻或股票报价的问题。虽然新闻本身是公共信息，但至关重要的一点是，必须要确保没有第三方在消息发送给用户的过程中篡改数据。在这里，消息的机密性是无关紧要的，但完整性却非常关键。我们构造想要确保，如果用户 Bob 拒绝所有带有无效的消息完整性标签的消息，那么攻击者就不能注入看起来合法的修改内容。有一点需要注意的是，攻击者仍然可以改变新闻报道到达 Bob 的顺序。例如，Bob 可能在看到 $1$ 号报告之前看到 $2$ 号报告。在某些情况下，这可能导致用户采取错误的行动。为了防止这种情况，新闻服务可能需要在每份报告中包含一个序列号，以便用户的机器可以缓冲报告，并确保用户总是能以正确的顺序看到新闻。
\end{example}

在本章中，我们只关注试图修改数据的攻击。我们不考虑拒绝服务 (Denial of Service, DoS) 攻击，即攻击者迟滞或阻止新闻到达用户。防御 DoS 攻击的常用方法是确保从发送方到接收方的网络中存在冗余路径，这样攻击者就很难封锁所有路径。我们在本章中不会讨论这些问题。

\begin{example}\label{exmp:6-2}
考虑一个在磁盘上存储数据的应用程序，如文字处理机或者邮件客户端。尽管应用程序的代码并不是机密的（甚至在公共领域中），但其完整性至关重要。在运行该程序之前，用户希望确保存储在磁盘上的代码没有被病毒篡改。为此，在第一次安装程序时，用户为代码计算出一个信息完整性标签，并将该标签与程序一起存储在磁盘上。之后，在每次启动应用程序之前，用户需要验证这个消息完整性标签。如果该标签仍然是有效的，用户就可以确信，自从该标签最初被生成以来，代码没有被修改过。显然，病毒可以同时覆盖应用程序的代码和完整性标签。尽管如此，我们的构造将确保没有病毒可以欺骗用户运行未经认证的代码。就像我们在例 \ref{exmp:6-1} 中所述的那样，攻击者可以交换两个认证程序，当用户启动程序 $A$ 时，它就运行程序 $B$。对此的标准防御方法是在可执行文件中包含程序名称。这样，当一个应用程序被启动时，系统可以向用户显示一个经过验证的应用程序名称。
\end{example}

那么，问题就在于，如何设计一个安全的消息完整性机制？我们首先需要论证以下基本原则：
\begin{quote}
在两个通信方之间提供消息的完整性需要发送方有一个对手不知道的密钥。
\end{quote}
没有密钥，想要确保消息完整性就是不可能的，因为对手拥有足够的信息来计算它选择的任意消息的完整性标签——它知道消息完整性算法是如何工作的，这就足以用来计算标签了。因此，所有的密码学消息完整性机制都需要一个对手不知道的密钥。在本章中，我们将假设发送方和接收方都将共享秘钥；但在后面的章节中，我们还将进一步放宽这一假设。

需要强调的是，不是为安全性而设计的通信协议中经常使用\emph{无密钥}的完整性机制。例如，以太网协议使用 CRC32 作为其消息完整性算法。这个算法是公开的，它将输出的 $32$ 比特标签嵌入到每个以太网帧中。TCP 协议使用一个无密钥的 $16$ 比特校验和，它会被嵌入到每个数据包中。我们强调，这些无密钥的完整性机制是为了检测\emph{随机的}传输错误而设计的，并不能针对恶意的篡改。上一段的论证表明，对手可以很容易地攻破这些机制，并产生看起来合法的消息。例如，在以太网的场景中，对手完全知道 CRC32 算法的工作原理，这样它就可以计算出任意消息的有效标签。然后，它就可以篡改以太网流量而不被发现。

\begin{figure}
  \centering
  \includegraphics[width=0.75\linewidth]{figures/chapter6/fig1.png}
  \caption{添加到消息上的短的消息完整性标签}
  \label{fig:6-1}
\end{figure}

\input{chapters/part1/chapter6/section1}
\input{chapters/part1/chapter6/section2}
\input{chapters/part1/chapter6/section3}
\input{chapters/part1/chapter6/section4}
\input{chapters/part1/chapter6/section5}
\input{chapters/part1/chapter6/section6}
\input{chapters/part1/chapter6/section7}
\input{chapters/part1/chapter6/section8}
\input{chapters/part1/chapter6/section9}
\input{chapters/part1/chapter6/section10}
\input{chapters/part1/chapter6/section11}
\input{chapters/part1/chapter6/section12}
\input{chapters/part1/chapter6/section13}
\input{chapters/part1/chapter6/section14}