\section{案例研究：802.11b WEP，一个千疮百孔的系统}\label{sec:9-10}

于 1999 年获批的 IEEE 802.11b 标准为短距离无线通信 (WiFi) 提供了一个协议。其安全性由 802.11b 数据帧封装的有线等效加密 (Wired Equivalent Privacy, WEP) 协议提供。WEP 的设计目标是提供能够媲美有线网络的数据隐私性。然而，WEP 在这方面彻头彻尾地失败了，并且它为我们提供了一个极好的案例，展示了一个孱弱的设计是如何导致灾难性的后果的。

当启用 WEP 时，无线网络中的所有成员都会共享一个长期密钥 $k$。该标准支持 $40$ 或 $128$ 比特密钥。$40$ 比特的版本符合标准起草时美国的出口限制。我们将使用以下符号来描述 WEP：
\begin{itemize}
	\item WEP 加密使用 RC4 流密码。我们用 $\mathrm{RC4}(s)$ 表示当给定种子 $s$ 时，RC4 所产生的伪随机序列。
	\item 我们用 $CRC(m)$ 表示消息 $m\in\{0,1\}^*$ 的 $32$ 比特 CRC 校验和。CRC 的实现细节与我们这里的讨论无关，读者只需将 CRC 视为从任意比特序列映射到 $\{0,1\}^{32}$ 的某个特定函数。
\end{itemize}

令 $m$ 是一个 802.11b 明文帧。$m$ 的前几个比特编码了 $m$ 的长度。为了加密一个 802.11b 帧 $m$，发送者选择一个 $24$ 比特的 IV，并计算：
\[
\begin{aligned}
& c\leftarrow\big(m\,\Vert\,\mathrm{CRC}(m)\big)\oplus\mathrm{RC4}(\mathrm{IV}\,\Vert\,k)\\
& c_\mathrm{full}\leftarrow(\mathrm{IV},\,c)
\end{aligned}
\]
WEP 的加密过程如图 \ref{fig:9-4} 所示。接收者首先计算 $c\oplus\mathrm{RC4}(\mathrm{IV}\,\Vert\,k)$ 来解密得到数对 $(m,s)$。如果 $s=\mathrm{CRC}(m)$，接收方就接受该帧，否则就拒绝它。

\begin{snote}[攻击 1：IV 碰撞。]
WEP 的设计者明白，流密码的密钥不应该被重复使用。因此，他们使用一个 $24$ 比特的 IV 来派生出每一帧的密钥 $k_\mathrm{f}:=\mathrm{IV}\,\Vert\,k$。然而，该标准并没有规定如何选择 IV，而许多实现都做得不够好。我们说，每当一个无线基站碰巧发送了两个帧，例如第 $i$ 帧和第 $j$ 帧，而它们都是由相同的 IV 加密得到的，IV 碰撞就会发生。由于 IV 是以透明方式发送的，所以窃听者很容易发现 IV 碰撞。此外，一旦 IV 碰撞发生，攻击者就可以使用 \ref{subsec:3-3-1} 小节中讨论的两次性密码本攻击来解密 $i$ 和 $j$ 这两个帧。

那么，IV 碰撞发生的概率到底有多大？根据生日悖论，如果为每一帧选择一个随机 IV，那么预期每隔 $\sqrt{2^{24}}=2^{12}=4096$ 帧，就会发生一次 IV 碰撞。由于每帧最长是 $1156$ 字节，那么平均每传输大约 4 MB 的数据，就会发生一次碰撞。

除此之外，我们也可以使用一个计数器来生成 IV。该实现会在发送 $2^{24}$ 帧后耗尽整个 IV 空间，对于一个满负荷工作的无线接入点来说，这只需要大约一天时间。更糟糕的是，一些使用计数器方法的无线网卡在开机时会将计数器重置为 $0$。因此，这些网卡会经常重复使用较小的 IV，而这会让流量极易遭受两次性密码本攻击。
\end{snote}

\begin{figure}
  \centering
  \input{figures/chapter9/fig4.tex}
  \caption{WEP 加密}
  \label{fig:9-4}
\end{figure}

\begin{snote}[攻击 2：相关密钥。]
对 WEP 加密的一种更具破坏性的攻击来自对相关 RC4 密钥的使用。在第\ref{chap:3}章中，我们曾经解释，必须为每条加密消息选择一个新的、\emph{随机的}流密码密钥。然而，WEP 所使用的密钥 $1\,\Vert\,k$，$2\,\Vert\,k$，$\dots$ 都是密切相关的——它们都有相同的后缀 $k$。RC4 从来就不是为这种目的而设计的，事实上，它在这些情况下是完全不安全的。Fluhrer、Mantin 和 Shamir 表明，在发送了大约一百万个 WEP 帧后，窃听者就可以恢复整个长期密钥 $k$ \cite{fluhrer2001weaknesses}。该攻击由 Stubblefield、Ioannidis 和 Rubin 实现 \cite{stubblefield2004key}，现在可被用于各种黑客工具，如 \textsc{WepCrack} 和 \textsc{AirSnort}。

应该使用一个 PRF 来生成每个帧的帧密钥，比如说将第 $i$ 帧的密钥设置为 $k_i:=F(k,\mathrm{IV})$——所产生的密钥和随机独立的密钥是无法区分的。当然，虽然这种方法确实可以防止相关密钥问题，但无法解决上面讨论的 IV 碰撞问题，以及接下来讨论的可塑性问题。
\end{snote}

\begin{snote}[攻击 3：易被控制性。]
回顾一下，WEP 试图使用 CRC 校验来为认证加密提供完整性。在某种意义上，WEP 使用的是先 MAC 后加密的方法，但它使用的是 CRC，而不是 MAC。我们表明，尽管包含加密步骤，但这种构造其实完全无法提供密文完整性。

针对它的攻击利用了 CRC 的线性特性。也就是说，对于某条消息 $m$，给定 $\mathrm{CRC}(m)$，我们很容易为任何的 $\Delta$ 计算出 $\mathrm{CRC}(m\oplus\delta)$。更确切地说，存在一个公共函数 $L$，对于任何的 $m$ 和 $\Delta\in\{0,1\}^\ell$，我们都有：
\[
\mathrm{CRC}(m\oplus\Delta)=\mathrm{CRC}(m)\oplus L(\Delta)
\]
这一属性使攻击者可以对 WEP 密文进行任意的修改，而不会被接收方发现。令 $c$ 是一条 WEP 密文，即：
\[
c=\big(m,\mathrm{CRC}(m)\big)\oplus\mathrm{RC4}(\mathrm{IV}\,\Vert\,k)
\]
因此，$c'$ 可以完全无误地被解密为 $m\oplus\Delta$。我们可以发现，给定对 $m$ 的加密，攻击者就可以为它所选择的任何一个 $\Delta$ 创建一个对 $m\oplus\Delta$ 的有效加密。我们已经在 \ref{subsec:3-3-2} 小节解释过，这很有可能会导致严重的攻击。
\end{snote}

\begin{snote}[攻击4：选择的密码文本攻击。]
该协议还容易受到一种被称为\textbf{断续攻击 (chop-chop)}的选择密文攻击，这种攻击可以让攻击者解密由其选择的加密帧。我们会在练习 \ref{exer:9-5} 中描述这种攻击的一个简单版本。
\end{snote}

\vspace*{-10pt}

\begin{snote}[攻击5: 拒绝服务。]
我们简单提一下，802.11b 曾遭受过许多严重的拒绝服务 (Denial of Service, DoS) 攻击。比如说，在 802.11b 中，一旦客户端结束了网络调用，无线客户端就会向无线基站发送一条``断联"的消息。这是为了让无线基站能够释放分配给该客户端的内存资源。不幸的是，``断联"信息不会经过任何认证，也就是说，任何人都可以代表其他人发送断联消息。一旦断联，受害者将需要几秒钟才能和基站重新建立连接。因此，只要每隔几秒钟就向基站发送一次``断联"消息，攻击者就可以阻止任何由其选定的计算机连接到无线网络中。一些 802.11b 工具，比如 \texttt{Void11}，就实现了这种攻击。
\end{snote}

\begin{snote}[802.11i。]
在 802.11b WEP 协议失败后，一个名为 802.11i 的新标准在 2004 年得到批准。802.11i 使用一种称作 CCM 的先加密后 MAC 模式来提供认证加密。具体地说，CCM 使用（原生）CBC-MAC 进行 MAC，并使用计数器模式进行加密。802.11i 使用 AES 作为底层的 PRF 来实现这两者。后来，CCM 被 NIST 采纳为联邦标准 \cite{dworkin2004sp}。
\end{snote}